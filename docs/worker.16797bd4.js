!function(){let e=(e,...t)=>{if(!e)return t;for(let r=0,n=t.length;r<n;r++)e[r]=t[r];return e},t=(t,r)=>{let[n,o,l,i]=r,a=n+n,s=o+o,f=l+l,u=n*a,c=n*s,d=n*f,h=o*s,p=o*f,y=l*f,w=i*a,g=i*s,m=i*f;return e(t||[],1-h-y,c+m,d-g,c-m,1-u-y,p+w,d+g,p-w,1-u-h)},r=(e,t=e=>void 0!==e?": "+e:"")=>class extends Error{origMessage;constructor(r){super(e(r)+t(r)),this.origMessage=void 0!==r?String(r):""}},n=r(()=>"illegal arity"),o=e=>{throw new n(e)},l=(e,t)=>"function"==typeof e?.[t],i=e=>l(e,"xform")?e.xform():e,a=e=>"function"==typeof e?.[Symbol.iterator],s=(e,t)=>[e[0],e[1],t],f=Symbol(),u=()=>{},c=e=>e,d=e=>null!=e&&"function"!=typeof e&&void 0!==e.length;class h{value;constructor(e){this.value=e}deref(){return this.value}}let p=e=>new h(e),y=e=>e instanceof h,w=e=>e instanceof h?e:new h(e),g=e=>e instanceof h?e.deref():e,m=e=>2===e.length?[void 0,e[1]]:3===e.length?[e[1],e[2]]:o(e.length);function $(...e){let t=e[0],r=t[0],n=t[1],o=t[2],i=null==(e=m(e))[0]?r():e[0],a=e[1];return g(n(l(a,"$reduce")?a.$reduce(o,i):d(a)?v(o,i,a):b(o,i,a)))}let v=(e,t,r)=>{for(let n=0,o=r.length;n<o;n++)if(y(t=e(t,r[n]))){t=t.deref();break}return t},b=(e,t,r)=>{for(let n of r)if(y(t=e(t,n))){t=t.deref();break}return t},x=(e,t)=>[e,c,t];function*_(e,t){let r=i(e)([u,u,(e,t)=>t])[2];for(let e of t){let t=r(f,e);if(y(t)){(t=g(t.deref()))!==f&&(yield t);return}t!==f&&(yield t)}}let A=(e,t,r=_)=>{let n=t.length-1;return a(t[n])?t.length>1?r(e.apply(null,t.slice(0,n)),t[n]):r(e(),t[0]):void 0};function M(e,t){return a(t)?_(M(e),t):t=>{let r=t[2];return s(t,(t,n)=>r(t,e(n)))}}class U{from;to;step;constructor(e,t,r){void 0===e?(e=0,t=1/0):void 0===t&&(t=e,e=0),r=void 0===r?e<t?1:-1:r,this.from=e,this.to=t,this.step=r}*[Symbol.iterator](){let{from:e,to:t,step:r}=this;if(r>0)for(;e<t;)yield e,e+=r;else if(r<0)for(;e>t;)yield e,e+=r}$reduce(e,t){let r=this.step;if(r>0)for(let n=this.from,o=this.to;n<o&&!y(t);n+=r)t=e(t,n);else for(let n=this.from,o=this.to;n>o&&!y(t);n+=r)t=e(t,n);return t}}let F=(e,t,r)=>{let n,l;switch(r.length){case 4:l=r[3],n=r[2];break;case 3:l=r[2];break;case 2:return M(t=>e(r[0],r[1],t));default:o(r.length)}return t(i(r[0])(r[1]),n,l)};function*I(...e){let t=e.map(e=>e[Symbol.iterator]());for(;;){let e=[];for(let r of t){let t=r.next();if(t.done)return;e.push(t.value)}yield e}}r(()=>"unsupported operation");let E="o,a,b",k="io=0,ia=0,ib=0,so=1,sa=1,sb=1",S="!o&&(o=a);",C=e=>t=>t>1?`${e}[i${e}+${t}*s${e}]`:1==t?`${e}[i${e}+s${e}]`:`${e}[i${e}]`,j=e=>M(C(e),new U(void 0,void 0,void 0)),D=e=>M(t=>`${e}[${t}]`,new U(void 0,void 0,void 0)),P=(e,t,r,n="a",l="",f="",u="",c=!1)=>{var d;let h;return[f,function e(...t){return F(e,$,t)}(function(...e){return(function e(...t){let[r,n,l,i,a,s,f,u,c,d]=t;switch(t.length){case 0:o(0);case 1:return r;case 2:return(...e)=>r(n(...e));case 3:return(...e)=>r(n(l(...e)));case 4:return(...e)=>r(n(l(i(...e))));case 5:return(...e)=>r(n(l(i(a(...e)))));case 6:return(...e)=>r(n(l(i(a(s(...e))))));case 7:return(...e)=>r(n(l(i(a(s(f(...e)))))));case 8:return(...e)=>r(n(l(i(a(s(f(u(...e))))))));case 9:return(...e)=>r(n(l(i(a(s(f(u(c(...e)))))))));default:let h=(...e)=>r(n(l(i(a(s(f(u(c(d(...e))))))))));return 10===t.length?h:e(h,...t.slice(10))}}).apply(null,e=e.map(i))}(function e(t,r){return a(r)?function*(e,t){let r=i(e)(x(()=>[],(e,t)=>(e.push(t),e))),n=r[1],o=r[2];for(let e of t){let t=o([],e);if(y(t)){yield*g(n(t.deref()));return}t.length&&(yield*t)}yield*g(n([]))}(e(t),r):e=>{let r=e[2],n=t;return s(e,(e,t)=>--n>0?r(e,t):0===n?w(r(e,t)):p(e))}}(e),function e(...t){return A(e,t)||(e=>{let r=e[2],n=t[0],o=t[1]||0;return s(e,(e,t)=>r(e,n(o++,t)))})}((e,r)=>t(r,e))),(d=(d=l)||"",h=!0,x(()=>"",(e,t)=>(e=h?e+t:e+d+t,h=!1,e))),I.apply(null,r.split(",").map(c?j:D))),u,""!==n?`return ${n};`:""]},B=(e,t=E,r="o",n=S,o)=>[n,"while(k--\x3e0) {",e(t.split(",").map(e=>`${e}[i${e}+k*s${e}]`)),"}",o,null!==r?`return ${r};`:""],T=(e,t)=>`!${e} && (${e}=${t.split(",")[1]});`,V=(e,t,r,n=r,o="a",l,i,a,s=!1)=>Function(r,P(e,t,n,o,l,i,a,s).join("")),q=(e,t,r=t,n,o,l)=>Function(t,B(e,r,n,o,l).join("")),[z,O,W,G]=((e,t=E,r=k,n=E,o="o",l,i=[2,3,4])=>[q(e,`${t},k,${r}`,n,o,void 0),...i.map(l=>V(l,e,`${t},${r}`,n,o,"",T(o,n),"",!0))])(([e,t])=>`${e}=${t}*n;`,"o,a,n","io=0,ia=0,so=1,sa=1","o,a");(e=>{let r,n,o;let l=0,i=[],a=new Uint32Array,s=0,f=!1,u=!1,c=!1,d=(e,t=0)=>o?.findIndex(r=>e<(t+=r?.count??0))??-1,h=(()=>{let e=new Float32Array(1),t=new Int32Array(e.buffer);return r=>{let n;e[0]=r;let o=t[0],l=o>>23&255,i=8388607&o;return 0===l?n=0:l<113?(n=0,i|=8388608,0x1000000&(i>>=113-l)&&(n=1,i=0)):l<142?n=l-112:(n=31,i=0),(o>>31&1)<<15|n<<10|i>>13}})(),p=(e,t)=>(h(e)|h(t)<<16)>>>0,y=()=>{if(f)return;let o=n;f=!0,function(n){if(!r)return c=!1;let o=new Float32Array(r);if(u||s!==l)(function(){if(!r)return u=!1;let n=new Float32Array(r),o=new Uint8Array(r),i=Math.ceil(2*l/2048),a=new Uint32Array(2048*i*4),s=new Uint8Array(a.buffer),f=new Float32Array(a.buffer);for(let e=0;e<l;e++){let r,l,i=8*e,u=8*e;f[i++]=n[u++],f[i++]=n[u++],f[i++]=n[u++],f[i++]=d(e);let c=n[u++],h=n[u++],y=n[u++];l=4*u;let w=(o[l++]-128)/128,g=t([],[(o[l++]-128)/128,(o[l++]-128)/128,(o[l++]-128)/128,w]),[m,$,v,b,x,_,A,M,U]=W(g,W(g,W(g,g,c),h,3,3),y,6,6),F=m*m+b*b+A*A,I=m*$+b*x+A*M,E=m*v+b*_+A*U,k=$*$+x*x+M*M,S=$*v+x*_+M*U,C=v*v+_*_+U*U;a[i++]=p(4*F,4*I),a[i++]=p(4*E,4*k),a[i++]=p(4*S,4*C),r=4*i,s[r++]=o[l++],s[r++]=o[l++],s[r++]=o[l++],s[r++]=o[l++]}e.postMessage({texdata:a,width:2048,height:i,freshData:u},[a.buffer]),u=!1})(),s=l;else if(!c&&.01>Math.abs(i[2]*n[2]+i[6]*n[6]+i[10]*n[10]-1))return;console.time("sort");let f=-1/0,h=1/0,y=new Int32Array(l);for(let e=0;e<l;e++){let t=8*e,r=0|4096*(n[2]*o[t++]+n[6]*o[t++]+n[10]*o[t++]);y[e]=r,r>f&&(f=r),r<h&&(h=r)}let w=65535/(f-h),g=new Uint32Array(65536);for(let e=0;e<l;e++)y[e]=(y[e]-h)*w|0,g[y[e]]++;let m=new Uint32Array(65536);for(let e=1;e<65536;e++)m[e]=m[e-1]+g[e-1];a=new Uint32Array(l);for(let e=0;e<l;e++)a[m[y[e]]++]=e;console.timeEnd("sort"),e.postMessage({depthIndex:a,viewProjection:n,vertexCount:l,freshSort:c},[a.buffer]),i=n,c=!1}(n),setTimeout(()=>{f=!1,(u||c||o!==n||s!==l)&&y()})};e.onmessage=t=>{let{ply:i,save:a,freshData:s,freshSort:f,buffer:d,vertexCount:h,meta:p,viewProjection:w}=t.data;i?e.postMessage({buffer:function(e){let t=new Uint8Array(e),r=new TextDecoder().decode(t.slice(0,10240)),n="end_header\n",o=r.indexOf(n);if(o<0)throw Error("Unable to read .ply file header");let l=parseInt(/element vertex (\d+)\n/.exec(r)[1]),i=0,a={},s={};console.log("Vertex Count",l);let f=new Map().set("double",["getFloat64"]).set("int",["getInt32"]).set("uint",["getUint32"]).set("float",["getFloat32"]).set("short",["getInt16"]).set("ushort",["getUint16"]).set("uchar",["getUint8"]).set("",["getInt8"]);for(let e of(f.forEach(e=>e.push(parseInt(e[0].replace(/[^\d]/g,""))/8)),r.slice(0,o).split("\n").filter(e=>e.startsWith("property ")))){let[t,r,n]=e.split(" "),[o,l]=f.get(r)||f.get("");s[n]=o,a[n]=i,i+=l}console.log("Bytes per row",i,s,a);let u=new DataView(e,o+n.length),c=0,d=new Proxy({},{get(e,t){if(!s[t])throw Error(t+" not found");return u[s[t]](c*i+a[t],!0)}});console.time("calculate importance");let h=new Float32Array(l),p=new Uint32Array(l);for(c=0;c<l;c++){if(p[c]=c,!s.scale_0)continue;let e=Math.exp(d.scale_0)*Math.exp(d.scale_1)*Math.exp(d.scale_2);h[c]=e*(1/(1+Math.exp(-d.opacity)))}console.timeEnd("calculate importance"),console.time("sort"),p.sort((e,t)=>h[t]-h[e]),console.timeEnd("sort");let y=new ArrayBuffer(32*l);console.time("build buffer");for(let e=0;e<l;e++){let t,r;c=p[e];let n=32*e,o=new Float32Array(y,n,t=3),l=new Float32Array(y,n+=4*t,t=3),i=new Uint8ClampedArray(y,n+=4*t,r=4),a=new Uint8ClampedArray(y,n+=r,r=4);if(o[0]=d.x,o[1]=d.y,o[2]=d.z,s.scale_0){l[0]=Math.exp(d.scale_0),l[1]=Math.exp(d.scale_1),l[2]=Math.exp(d.scale_2);let e=Math.sqrt(d.rot_0**2+d.rot_1**2+d.rot_2**2+d.rot_3**2);i[0]=d.rot_0/e*128+128,i[1]=d.rot_1/e*128+128,i[2]=d.rot_2/e*128+128,i[3]=d.rot_3/e*128+128}else l[0]=l[1]=l[2]=.01,i[0]=255,i[1]=i[2]=i[3]=0;s.f_dc_0?(a[0]=(.5+.28209479177387814*d.f_dc_0)*255,a[1]=(.5+.28209479177387814*d.f_dc_1)*255,a[2]=(.5+.28209479177387814*d.f_dc_2)*255):(a[0]=d.red,a[1]=d.green,a[2]=d.blue),a[3]=(s.opacity?1/(1+Math.exp(-d.opacity)):1)*255}return console.timeEnd("build buffer"),y}(i),save:!!a,meta:p}):(d&&(r=d),null!=h&&(l=h),null!=p&&(o=p),null!=s&&(u=s),null!=f&&(c=f),w&&(n=w),(s||f||w)&&y())}})(self)}();